<!DOCTYPE html><html><head><meta charset="utf-8"><title>Setting Up NetBSD Kernel Dev Environment | Aditya</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="I used T_PAGEFLT’s blog post as a reference for setting my NetBSD kernel development environment since his website is down I’m putting down the steps here so it would be helpful for starters.This is a"><meta property="og:type" content="article"><meta property="og:title" content="Setting Up NetBSD Kernel Dev Environment"><meta property="og:url" content="http://adityapadala.com/2020/04/20/Setting-Up-NetBSD-Kernel-Dev-Environment/index.html"><meta property="og:site_name" content="Aditya"><meta property="og:description" content="I used T_PAGEFLT’s blog post as a reference for setting my NetBSD kernel development environment since his website is down I’m putting down the steps here so it would be helpful for starters.This is a"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2020-04-20T17:39:42.000Z"><meta property="article:modified_time" content="2020-04-20T19:01:25.196Z"><meta property="article:author" content="Aditya Vardhan Padala"><meta property="article:tag" content="netbsd, environment"><meta name="twitter:card" content="summary"><link rel="icon" href="/favicon.png"><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Aditya" type="application/atom+xml"></head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">A </span><span class="w">d </span><span class="b">i </span><span class="b">t </span><span class="b">y </span><span class="w">a </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-Setting-Up-NetBSD-Kernel-Dev-Environment" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">Setting Up NetBSD Kernel Dev Environment</h1><div class="article-meta">Posted on <time class="article-time" datetime="2020-04-20T17:39:42.000Z" itemprop="datePublished">Apr 20, 2020</time></div></header><div class="article-entry" itemprop="articleBody"><p>I used T_PAGEFLT’s blog post as a reference for setting my NetBSD kernel development environment since his website is down I’m putting down the steps here so it would be helpful for starters.</p><p>This is an overview of my setup:</p><ol><li>Linux Host With Qemu Target</li><li>Tracing and Debugging using qemu’s built-in gdb server.</li><li>Use a cronjob with rsync to keep my files updated b/w host and guest.</li><li>pkgin for simpicity.(Sometimes have to use pkg_add to get stuff done)</li></ol><h2 id="Host-Configuration"><a href="#Host-Configuration" class="headerlink" title="Host Configuration"></a>Host Configuration</h2><p>Make sure you have the latest version of qemu installed as we will be using x86-64 NetBSD guests.</p><p>We will be needing GDB that is configured with NetBSD x86_64 abi. So we need to compile it ourself.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftp.gnu.org/gnu/gdb/gdb-xxxx.tar.xz</span><br><span class="line">tar xvf gdb-xxxx.tar.xz</span><br><span class="line">sudo mkdir -p /opt &amp;&amp; cd gdb-xxxx</span><br><span class="line">./configure --prefix=/opt --target=x86_64-netbsd</span><br><span class="line">make -j4 &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure><h3 id="Building-from-NetBSD-current"><a href="#Building-from-NetBSD-current" class="headerlink" title="Building from NetBSD-current"></a>Building from NetBSD-current</h3><p>First step get the files.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir netbsd &amp;&amp; cd netbsd</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;NetBSD&#x2F;src</span><br><span class="line">cd src</span><br></pre></td></tr></table></figure><p>Now for the time taking part, compiling the sources.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;build.sh -m amd64 -T ..&#x2F;tooldir -D ..&#x2F;destdir -R ..&#x2F;releasedir -O ..&#x2F;objdir -U -j6 release iso-image</span><br><span class="line"># Now get some sleep it&#39;ll take some time.</span><br></pre></td></tr></table></figure><p>Upon completion the directories will have the following files:</p><ul><li>Cross-compilation toolchain in “tooldir”</li><li>Bootable image in “releasedir/images”</li></ul><h2 id="Now-getting-the-guest-up-and-running"><a href="#Now-getting-the-guest-up-and-running" class="headerlink" title="Now getting the guest up and running"></a>Now getting the guest up and running</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create ~/vhd/netbsd-current.img 10G</span><br><span class="line">qemu-system-x86_64 -smp 4 -drive file=vhd/netbsd-current.img,format=raw \</span><br><span class="line">                     -cdrom ~/Code/netbsd-current/releasedir/images/NetBSD-8.99.12-amd64.iso\</span><br><span class="line">		     -m 2048 -enable-kvm \</span><br><span class="line">		     -net user,hostfwd=tcp::5022-:22 -n</span><br></pre></td></tr></table></figure><p>No go through the standard installation without unnecessary clutter like x11,games etc.<br>Configure all the necessary things such as ssh, users, sheel preference.<br>After the completion of installation</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -smp 4 -drive file=vhd/netbsd-current.img,format=raw \</span><br><span class="line">                     -m 2048 -enable-kvm \</span><br><span class="line">		     -net user,hostfwd=tcp::5022-:22 -net nic</span><br></pre></td></tr></table></figure><p>This should drop you a vm instance.</p><h3 id="Installing-pkgin"><a href="#Installing-pkgin" class="headerlink" title="Installing pkgin"></a>Installing pkgin</h3><p>Once you are up and running better to install pkgin. It makes package management easier.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">su -</span><br><span class="line">export PKG_URL="http://cdn.netbsd.org/pub/pkgsrc/packages/NetBSD/amd64/9.0_2019Q4/All"</span><br><span class="line"><span class="meta">#</span><span class="bash"> change the above url accordingly</span></span><br><span class="line">pkg_add "$PKG_URL/pkgin-0.9.4nb6.tgz"</span><br><span class="line">echo $PKG_URL &gt; /usr/pkg/etc/pkgin/repositories.conf</span><br><span class="line">pkgin update</span><br><span class="line">``` </span><br><span class="line">Now we can install all the necessary utilities that makes life easier.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Compiling kernels</span></span></span><br><span class="line"></span><br><span class="line">NetBSD runs the default GENERIC configuration. So we make a few changes to this and compile our own kernel.</span><br><span class="line">```shell</span><br><span class="line">cd ~/netbsd/src/sys/arch/amd64/conf</span><br><span class="line">cp GENERIC QEMU</span><br></pre></td></tr></table></figure><p>Use the text editor of your choice and fiddle with the configuration.</p><p>make sure you have</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">makeoptions     DEBUG="-g"      # compile full symbol table for CTF</span><br></pre></td></tr></table></figure><p>Now all that is left is compiling.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./build.sh -m amd64 -T ../tooldir -D ../destdir -R ../releasedir -O ../objdir -U -u -j6 kernel=QEMU</span><br><span class="line"><span class="meta">#</span><span class="bash"> This should complete fairly quick</span></span><br></pre></td></tr></table></figure><p>Now scp the files to vm and repace the old kernel</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scp -P 5022 ~/netbsd/objdir/sys/arch/amd64/compile/QEMU/netbsd root@localhost:~</span><br><span class="line">ssh -p 5022 root@localhost</span><br><span class="line"><span class="meta">#</span><span class="bash"> We forwared VM<span class="string">'s port 22 --&gt; Host 5022 for ssh acceess</span></span></span><br><span class="line">cp /netbsd /neetbsd.old</span><br><span class="line">cp ~/netbsd /netbsd</span><br><span class="line"><span class="meta">#</span><span class="bash"> Reboot with the new kernel</span></span><br></pre></td></tr></table></figure><h3 id="Debugging-with-gdb"><a href="#Debugging-with-gdb" class="headerlink" title="Debugging with gdb"></a>Debugging with gdb</h3><p>Start VM with qemu’s gdb stub forwarding tcp through port 1234.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 -drive file&#x3D;vhd&#x2F;netbsd-current.img,format&#x3D;raw \</span><br><span class="line">                     -m 1024 -enable-kvm \</span><br><span class="line">		    -gdb tcp::1234</span><br></pre></td></tr></table></figure><p>We already compiled netbsd kernel with complete symbol table.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~&#x2F;netbsd&#x2F;objdir&#x2F;sys&#x2F;arch&#x2F;amd64&#x2F;compile&#x2F;QEMU</span><br><span class="line">&#x2F;opt&#x2F;bin&#x2F;x86_64-netbsd-gdb .&#x2F;netbsd.gdb</span><br></pre></td></tr></table></figure><p>Now just simply enter</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) target remote localhost:1234</span><br><span class="line">Remote debugging using localhost:1234</span><br><span class="line">0xffffffff8021d16e in x86_stihlt ()</span><br></pre></td></tr></table></figure></div><div class="article-tags"><a class="tag-link" href="/tags/netbsd-environment/" rel="tag">netbsd, environment</a></div><section id="comments" class="white-box"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript></div></section></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="http://adityapadala.com">Aditya</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a href="https://hexo.io/" target="_blank" rel="external noopener">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix" style="display:none"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc" style="display:none"><div class="no-index">No Index</div></div><div class="site-bio show" style="display:block"><div class="about-me clearfix"><div class="avatar"><img src="/img/avatar.jpg"></div><div class="info"><a class="name dark-btn" href="/about">Aditya Vardhan Padala</a></div><div class="info"><span class="item desc"></span></div></div><div class="social clearfix"><a href="/atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="https://github.com/adityavardhanpadala" class="github" target="_blank" rel="external"><span class="icon icon-github"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script type="text/javascript">var disqus_shortname="Aditya Vardhan",disqus_url="http://adityapadala.com/2020/04/20/Setting-Up-NetBSD-Kernel-Dev-Environment/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>